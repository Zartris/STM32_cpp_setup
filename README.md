# STM32 C++ Project Template for CubeMX

This repository provides a template for integrating C++ code into STM32 projects generated by STM32CubeMX. It ensures compatibility with CubeMX's C-based `main()` function while allowing you to develop your application logic in C++.

## Prerequisites

*   **STM32CubeMX:** Used to generate the base project code, including HAL drivers and initial configurations.
*   **ARM GCC Toolchain:** A cross-compiler for ARM Cortex-M processors. Make sure it's installed and the path is added to your environment variables.
*   **Make:** The `make` build utility.
*   **An STM32CubeMX Generated Project:**  You must have an existing STM32 project set up using CubeMX for your specific microcontroller.

## Project Structure

This template uses the following directory structure to organize the project:
stm32-cpp-template/
 ├── .vscode/ # Optional: VS Code settings 
 ├── Core/ # CubeMX generated files (HAL, main.c, etc.) 
 │ ├── Inc/ # Header files (main.h, mainCpp.h) 
 │ └── Src/ # Source files (main.c) 
 ├── App/ # Your C++ application code 
 │ ├── Inc/ # Application header files (app.hpp) 
 │ └── Src/ # Application source files (app.cpp) 
 ├── Drivers/ # Optional: drivers 
 ├── Makefile # Build system configuration 
 ├── linker.ld # Optional: Linker script 
 └── README.md # Project documentation

## Project Structure Additions

You will need to add the following to your project:

*   **`Core/Inc/mainCpp.h`:** Header file for the C++ entry point.
*   **`Core/Src/app.cpp`:** C++ source file containing your application code.
*   **`Core/Inc/app.hpp`:** C++ header file containing the class definition.

## C++ Integration Steps

These are the essential steps to set up your CubeMX project for C++ development:

1.  **Create the `App` Folder:**
    *   Create a top-level folder named `App`.
    *   Inside `App`, create two subfolders: `Inc` and `Src`.

2.  **Create `App/Inc/app.hpp`:**
    *   Create `app.hpp` inside the `App/Inc` directory.
    *   This file contains the definition of your main application class (typically named `App`).

    ```c++
    #pragma once
    #include "main.h"

    class App
    {
    private:
        App() {}
        static App instance;

    public:
        static App &getInstance()
        {
            return instance;
        }
        bool init();
        void run();
    };
    ```

3.  **Create `App/Src/app.cpp`:**
    *   Create `app.cpp` inside the `App/Src` directory.
    *   This file contains the `mainCpp()` function, your C++ application's entry point, and the implementation of the `App` class.

    ```c++
    #include "main.h"
    #include "app.hpp"

    #ifdef __cplusplus
    extern "C"
    {
    #endif
        void mainCpp(void)
        {
            App &app = App::getInstance();
            if (!app.init())
            {
                Error_Handler();
            }
            while (1)
            {
                app.run();
            }
        }
        void handleErrorCpp(void)
        {
            Error_Handler();
        }
    #ifdef __cplusplus
    }
    #endif
    
    App App::instance;

    bool App::init()
    {
        // Place your initialization code here.
        return true;
    }

    void App::run()
    {
        // Place your main application loop logic here.
        HAL_Delay(100);
    }
    ```

4.  **Create `Core/Inc/mainCpp.h`:**
    *   Create `mainCpp.h` inside the `Core/Inc` directory.
    *   This header provides the necessary `extern "C"` declarations to make your C++ functions callable from C code (specifically, from `main.c`).

    ```c++
    #pragma once
    #ifdef __cplusplus
    extern "C"
    {
    #endif
        void mainCpp(void);
        void handleErrorCpp(void);
    #ifdef __cplusplus
    }
    #endif
    ```

5.  **Modify `Core/Src/main.c`:**
    *   Open the `main.c` file generated by CubeMX.
    *   Include `mainCpp.h` at the top of the file:

    ```c
    /* USER CODE BEGIN Includes */
    #include "mainCpp.h"
    /* USER CODE END Includes */
    ```

    *   Call `mainCpp()` just before the infinite loop. remove the loop as it is now inside the mainCpp function in app.cpp.

    ```c
    int main(void)
    {
        // ... CubeMX-generated initialization code ...

        /* Infinite loop */
        /* USER CODE BEGIN WHILE */
        mainCpp();
        /* USER CODE END WHILE */

        /* USER CODE BEGIN 3 */
        /* USER CODE END 3 */
    }
    ```

6. **Modify `Makefile`**
    * Add the correct include paths to the `INCLUDES`
    ```
        INCLUDES = \
        -I./Core/Inc \
        -I./App/Inc
    ```
    * Add the app.cpp file to the source file list.
    ```
        SOURCE = \
        ./Core/Src/main.c \
        ./App/Src/app.cpp
    ```

## Explanation

*   **`App/Inc/app.hpp` & `App/Src/app.cpp`:** These files contain your C++ application code.
    * `App::init()` is responsible for the initialization of your classes.
    * `App::run()` is the main run logic.
    * `mainCpp()` is the main cpp function. It will call your app init and run functions.
    * `handleErrorCpp()` will call the error handler.
    * A singleton class App is used here.
*   **`Core/Inc/mainCpp.h`:** This header file declares `mainCpp()` and `handleErrorCpp()` using `extern "C"`. This is crucial for calling C++ code from C.
*   **`Core/Src/main.c`:** This file is generated by CubeMX. You modify it to include `mainCpp.h` and to call the `mainCpp()` function.
* **Makefile**:
    * The `INCLUDES` are updated to add the `App/Inc` directory.
    * The `SOURCE` list is updated to add the `app.cpp` file.

## Key Considerations

*   **CubeMX Regeneration:** If you regenerate code with CubeMX, it will likely overwrite `main.c`. Be sure to reapply the `mainCpp.h` include and the `mainCpp()` call. You can copy paste the modified part, or make a copy of the modified file.
*   **C++ Entry Point:** `mainCpp()` in `app.cpp` is the entry point for your C++ code.
*   **Error Handling**: If an error occurs, the `handleErrorCpp()` will be called, which calls the `Error_Handler()` method.
* **App folder**: All your code should be in the app folder.
* **Makefile**: If new files are created, these should be added to the makefile.

## License

[Specify your license here, e.g., MIT License]